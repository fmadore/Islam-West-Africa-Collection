<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyword Occurrences Bar Chart Race</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #chart { width: 960px; height: 500px; margin: 0 auto; }
        .bar { fill: steelblue; }
        .label { font-size: 12px; }
        .axis { font-size: 12px; }
        .title { font-size: 18px; text-anchor: middle; }
        .year { font-size: 64px; text-anchor: end; }
        .bar-label { fill: white; font-weight: bold; }
    </style>
</head>
<body>
    <div id="chart"></div>
    <script>
        const width = 960;
        const height = 500;
        const margin = { top: 50, right: 30, bottom: 10, left: 180 };
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        g.append("text")
            .attr("class", "title")
            .attr("x", innerWidth / 2)
            .attr("y", -margin.top / 2)
            .text("Keyword Occurrences in Bénin");

        const xScale = d3.scaleLinear().range([0, innerWidth]);
        const yScale = d3.scaleBand().range([0, innerHeight]).padding(0.1);

        // Move x-axis to the top
        const xAxis = g.append("g")
            .attr("class", "axis x-axis");

        const yAxis = g.append("g")
            .attr("class", "axis");

        const yearLabel = g.append("text")
            .attr("class", "year")
            .attr("x", innerWidth)
            .attr("y", innerHeight - 5);

        // Add this color scale
        const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        d3.json("bar_chart_race_data_Bénin.json").then(data => {
            const n = 10;
            const duration = 1000;
            const delay = 250;

            // Create a set of all unique keywords
            const allKeywords = new Set(data.flatMap(yearData => yearData.data.map(item => item.name)));

            // Create a map to store cumulative values for each keyword
            let cumulativeMap = new Map(Array.from(allKeywords).map(keyword => [keyword, 0]));

            // Cumulate the values over years
            const cumulativeData = data.map(yearData => {
                const yearKeywords = new Set(yearData.data.map(item => item.name));
                
                const cumulativeYearData = {
                    year: yearData.year,
                    data: Array.from(allKeywords).map(keyword => {
                        const yearValue = yearData.data.find(item => item.name === keyword)?.value || 0;
                        const newValue = cumulativeMap.get(keyword) + yearValue;
                        cumulativeMap.set(keyword, newValue);
                        return {
                            name: keyword,
                            value: newValue
                        };
                    })
                };
                return cumulativeYearData;
            });

            const keyframes = cumulativeData.flatMap((d, i) => {
                const interpolator = d3.interpolateArray(
                    cumulativeData[i].data,
                    cumulativeData[i + 1]?.data || cumulativeData[i].data
                );
                return d3.range(0, 1, 1 / 4).map(t => ({
                    year: d.year + t,
                    data: interpolator(t)
                        .map(d => ({...d, value: Math.round(d.value)}))
                        .sort((a, b) => d3.descending(a.value, b.value))
                        .slice(0, n)
                }));
            });

            let frame = 0;
            let timer = d3.interval(() => {
                const keyframe = keyframes[frame];

                xScale.domain([0, d3.max(keyframe.data, d => d.value)]);
                yScale.domain(keyframe.data.map(d => d.name));

                const t = d3.transition().duration(duration).ease(d3.easeLinear);

                // Update x-axis at the top
                xAxis.transition(t)
                    .call(d3.axisTop(xScale).ticks(5));

                yAxis.transition(t).call(d3.axisLeft(yScale));

                const bars = g.selectAll(".bar")
                    .data(keyframe.data, d => d.name);

                bars.enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", 0)
                    .attr("y", d => yScale(d.name))
                    .attr("height", yScale.bandwidth())
                    .attr("width", d => xScale(d.value))
                    .attr("fill", d => colorScale(d.name));

                bars
                    .transition(t)
                    .attr("y", d => yScale(d.name))
                    .attr("width", d => xScale(d.value))
                    .attr("fill", d => colorScale(d.name));

                bars.exit()
                    .transition(t)
                    .attr("width", 0)
                    .remove();

                const labels = g.selectAll(".bar-label")
                    .data(keyframe.data, d => d.name);

                labels.enter()
                    .append("text")
                    .attr("class", "bar-label")
                    .attr("x", d => xScale(d.value) - 5)
                    .attr("y", d => yScale(d.name) + yScale.bandwidth() / 2)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", "end")
                    .text(d => d.name);

                labels
                    .transition(t)
                    .attr("x", d => xScale(d.value) - 5)
                    .attr("y", d => yScale(d.name) + yScale.bandwidth() / 2)
                    .text(d => `${d.name} (${d.value})`); // Remove toLocaleString() to avoid commas

                labels.exit()
                    .transition(t)
                    .attr("x", d => xScale(0))
                    .remove();

                yearLabel.text(Math.round(keyframe.year));

                frame = (frame + 1) % keyframes.length;
                if (frame === 0) timer.stop();
            }, duration + delay);
        });
    </script>
</body>
</html>